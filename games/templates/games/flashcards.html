{% extends "base.html" %}
{% block title %}–ö–∞—Ä—Ç–æ—á–∫–∏: {{ playlist.title }}{% endblock %}

{% block content %}

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
      <div class="text-center mb-4">
        <h2 class="mb-3">
          <i class="bi bi-card-checklist text-primary me-2"></i>{{ playlist.title }}
        </h2>
        <div class="d-flex align-items-center justify-content-center gap-3 mb-2">
          <div class="progress flex-grow-1" style="height: 10px;">
            <div id="progress-bar" class="progress-bar bg-primary progress-bar-striped"
                 role="progressbar" style="width: 0%"></div>
          </div>
          <span class="badge bg-primary rounded-pill" id="progress-text">0/{{ words|length }}</span>
        </div>
      </div>

      <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
      <div id="game-content">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
       <div class="card border-primary shadow-lg mb-1 mx-auto position-relative" style="max-width: 600px; min-height: 300px; border-radius: 15px;">
          <div class="card-body d-flex flex-column justify-content-center">
            <div class="text-center p-3 position-relative">
              <span class="badge bg-secondary mb-1">–°–ª–æ–≤–æ <span id="current-index">1</span> –∏–∑ {{ words|length }}</span>
              <h3 id="card-text" class="display-5 my-4">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>

              <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: -->
               <!-- <button
                class="btn  position-absolute top-0 end-0 m-2 p-1"
                style="width: 38px; height: 38px; font-size: 1rem; border-radius: 30%;"
                aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
                onclick="addToFavorites()"
              >
                ü§ç
              </button>-->

              <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
              <div id="card-details" class="alert alert-info mt-2" style="display: none; border-radius: 10px;"></div>
              <div id="card-context" class="alert alert-light mt-2" style="display: none; border-radius: 10px;"></div>
            </div>
          </div>
        </div>

<!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="text-center mb-4">
  <button id="flip-btn" class="btn btn-primary btn-sm rounded-pill px-4 me-2 mb-2 "
          onclick="toggleTranslation()">
    <i class="bi bi-arrow-repeat me-1"></i> <span id="flip-text">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</span>
  </button>
  <div class="d-flex justify-content-center gap-2 mb-3">
    <button id="details-btn" class="btn btn-outline-info rounded-pill"
            onclick="toggleDetails()">
      <i class="bi bi-info-circle"></i> –û–ø–∏—Å–∞–Ω–∏–µ
    </button>
    <button id="context-btn" class="btn btn-outline-secondary rounded-pill"
            onclick="toggleContext()">
      <i class="bi bi-quote"></i> –ö–æ–Ω—Ç–µ–∫—Å—Ç
    </button>

  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π - –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–∏–Ω —Ä—è–¥ -->
  <div class="d-flex flex-row flex-nowrap justify-content-center gap-2" id="action-buttons" style="display: none;">
    <button class="btn btn-danger btn-sm rounded-pill px-3 flex-grow-0 my-btn-small-text " onclick="markWord(false)">
      <i class="bi bi-x-circle me-1"></i> –ù–µ –∑–Ω–∞—é
    </button>
    <button class="btn btn-outline-warning btn-sm rounded-pill px-3 flex-grow-0 my-btn-small-text " onclick="skipWord()">
      <i class="bi bi-arrow-right me-1"></i> –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    </button>
    <button class="btn btn-success btn-sm rounded-pill px-3 flex-grow-0 my-btn-small-text " onclick="markWord(true)">
      <i class="bi bi-check-circle me-1"></i> –ó–Ω–∞—é
    </button>
  </div>
</div>

        </div>
      </div>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      <div class="text-center mt-4" id="result" style="display: none;">
        <div class="card shadow" style="border-radius: 15px;">
          <div class="card-header bg-light" style="border-radius: 15px 15px 0 0;">
            <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card border-success h-100" style="border-radius: 10px;">
                  <div class="card-body text-center">
                    <h5 class="card-title text-success">
                      <i class="bi bi-check-circle me-1"></i>–ü—Ä–∞–≤–∏–ª—å–Ω–æ
                    </h5>
                    <p class="display-4 text-success" id="known-count">0</p>
                    <p class="h5"><span id="known-percent">0</span>%</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card border-warning h-100" style="border-radius: 10px;">
                  <div class="card-body text-center">
                    <h5 class="card-title text-warning">
                      <i class="bi bi-arrow-right me-1"></i>–ü—Ä–æ–ø—É—â–µ–Ω–æ
                    </h5>
                    <p class="display-4 text-warning" id="skipped-count">0</p>
                    <p class="h5"><span id="skipped-percent">0</span>%</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card border-danger h-100" style="border-radius: 10px;">
                  <div class="card-body text-center">
                    <h5 class="card-title text-danger">
                      <i class="bi bi-x-circle me-1"></i>–û—à–∏–±–∫–∏
                    </h5>
                    <p class="display-4 text-danger" id="unknown-count">0</p>
                    <p class="h5"><span id="unknown-percent">0</span>%</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3 d-flex justify-content-center gap-3">
              <a href="{% url 'playlist_detail' playlist.id %}" class="btn btn-outline-secondary btn-lg rounded-pill">
                <i class="bi bi-arrow-left me-1"></i> –ù–∞–∑–∞–¥
              </a>
              <button onclick="restart()" class="btn btn-primary btn-lg rounded-pill">
                <i class="bi bi-arrow-repeat me-1"></i> –ó–∞–Ω–æ–≤–æ
              </button>
              <button onclick="repeatMistakes()" class="btn btn-danger btn-lg rounded-pill" id="repeat-mistakes-btn" style="display: none;">
                <i class="bi bi-exclamation-triangle me-1"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<div id="favorite-message" style="
    position: fixed;
    top: 10px;
    right: 10px;
    background: #4caf50;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    display: none;
    z-index: 1000;
    font-family: Arial, sans-serif;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
"></div>
</div>

{{ words|json_script:"word-data" }}
<script>
  const showWordFirst = {{ show_word_first|yesno:"true,false" }};
</script>
<script>
  const originalData = JSON.parse(document.getElementById('word-data').textContent);

  let data = [];
  let index = 0;
  let flipped = false;
  let known = 0;
  let unknown = 0;
  let skipped = 0;
  let currentWord = null;
  let gameFinished = false;
  let wordStats = [];
  let wrongWords = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å–ª–æ–≤

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const gameContent = document.getElementById("game-content");
  const cardText = document.getElementById("card-text");
  const currentIndex = document.getElementById("current-index");
  const cardDetails = document.getElementById("card-details");
  const cardContext = document.getElementById("card-context");
  const actionButtons = document.getElementById("action-buttons");
  const flipBtn = document.getElementById("flip-btn");
  const flipText = document.getElementById("flip-text");
  const detailsBtn = document.getElementById("details-btn");
  const contextBtn = document.getElementById("context-btn");
  const resultEl = document.getElementById("result");
  const progressBar = document.getElementById("progress-bar");
  const progressText = document.getElementById("progress-text");
  const knownCount = document.getElementById("known-count");
  const unknownCount = document.getElementById("unknown-count");
  const skippedCount = document.getElementById("skipped-count");
  const knownPercent = document.getElementById("known-percent");
  const unknownPercent = document.getElementById("unknown-percent");
  const skippedPercent = document.getElementById("skipped-percent");
  const repeatMistakesBtn = document.getElementById("repeat-mistakes-btn");

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function startSession() {
    data = shuffle([...originalData]);
    index = 0;
    known = 0;
    unknown = 0;
    skipped = 0;
    flipped = false;
    gameFinished = false;
    wordStats = [];
    wrongWords = [];

    resultEl.style.display = "none";
    gameContent.style.display = "block";
    actionButtons.style.display = "none";
    cardDetails.style.display = "none";
    cardContext.style.display = "none";

    updateProgress();
    showCard();
  }


console.log("Original data:", originalData);

function showCard() {
  if (gameFinished || index >= data.length) return;

  currentWord = data[index];
    console.log("Current word:", currentWord);
  currentIndex.textContent = index + 1;

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
  cardDetails.innerHTML = currentWord.details  || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
  cardContext.innerHTML = currentWord.context || "–ü—Ä–∏–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";

  // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –Ω–æ–≤–æ–º—É —Å–ª–æ–≤—É
  cardDetails.style.display = "none";
  cardContext.style.display = "none";

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç showWordFirst
  if (showWordFirst) {
    cardText.textContent = currentWord.word;
    flipped = false;
    flipText.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥";
  } else {
    cardText.textContent = currentWord.translation;
    flipped = true;
    flipText.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≤–æ";
  }

  actionButtons.style.display = "block";
}

  function toggleTranslation() {
    if (gameFinished) return;

    if (flipped) {
      cardText.textContent = currentWord.word;
      flipped = false;
      flipText.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥";
      actionButtons.style.display = "none";
    } else {
      cardText.textContent = currentWord.translation;
      flipped = true;
      flipText.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≤–æ";
      actionButtons.style.display = "flex";
    }
  }

  function toggleDetails() {
    if (gameFinished) return;
    cardDetails.style.display = cardDetails.style.display === "none" ? "block" : "none";
  }

  function toggleContext() {
    if (gameFinished) return;
    cardContext.style.display = cardContext.style.display === "none" ? "block" : "none";
  }

  function markWord(isKnown) {
    if (gameFinished) return;

    if (isKnown) {
      known++;
    } else {
      unknown++;
      wrongWords.push(currentWord); // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ –≤ —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
    }

    wordStats.push({
      word_id: currentWord.id,
      is_known: isKnown,
      playlist_id: {{ playlist.id }}
    });

    nextCard();
  }

  function skipWord() {
    if (gameFinished) return;

    skipped++;
    wrongWords.push(currentWord); // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ —Ç–æ–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
    nextCard();
  }

  function nextCard() {
    index++;
    updateProgress();

    if (index < data.length) {
      showCard();
    } else {
      finishGame();
    }
  }

  function updateProgress() {
    const progress = (index / data.length) * 100;
    progressBar.style.width = `${progress}%`;
    progressText.textContent = `${index}/${data.length}`;
  }

  function finishGame() {
    gameFinished = true;
    const total = known + unknown + skipped;
    const knownPct = total ? Math.round((known / total) * 100) : 0;
    const unknownPct = total ? Math.round((unknown / total) * 100) : 0;
    const skippedPct = total ? Math.round((skipped / total) * 100) : 0;

    knownCount.textContent = known;
    unknownCount.textContent = unknown;
    skippedCount.textContent = skipped;
    knownPercent.textContent = knownPct;
    unknownPercent.textContent = unknownPct;
    skippedPercent.textContent = skippedPct;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
    if (wrongWords.length > 0) {
      repeatMistakesBtn.style.display = "inline-block";
    } else {
      repeatMistakesBtn.style.display = "none";
    }

    gameContent.style.display = "none";
    resultEl.style.display = "block";

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    sendStatistics();
  }

  function sendStatistics() {
    const csrfToken = getCookie("csrftoken");

    fetch("/results/save/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({
        playlist_id: {{ playlist.id }},
        known: known,
        unknown: unknown,
        skipped: skipped,
      }),
    });

    if (wordStats.length > 0) {
      fetch("/results/save-word-results/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          word_results: wordStats
        }),
      });
    }
  }

  function restart() {
    startSession();
  }

  function repeatMistakes() {
    if (wrongWords.length === 0) return;

    // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Ç–æ–ª—å–∫–æ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
    data = shuffle([...wrongWords]);
    index = 0;
    known = 0;
    unknown = 0;
    skipped = 0;
    flipped = false;
    gameFinished = false;
    wordStats = [];
    wrongWords = []; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞

    resultEl.style.display = "none";
    gameContent.style.display = "block";
    actionButtons.style.display = "none";
    cardDetails.style.display = "none";
    cardContext.style.display = "none";

    updateProgress();
    showCard();
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener("keydown", function(event) {
    if (gameFinished) return;

    switch(event.key) {
      case "ArrowRight":
        event.preventDefault();
        markWord(true);
        break;
      case "ArrowLeft":
        event.preventDefault();
        markWord(false);
        break;
      case "ArrowUp":
        event.preventDefault();
        skipWord();
        break;
      case "ArrowDown":
        event.preventDefault();
        toggleDetails();
        break;
      case " ":
        event.preventDefault();
        toggleTranslation();
        break;
    }
  });

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  document.addEventListener("DOMContentLoaded", startSession);
</script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
<script>
function addToFavorites() {
  if (!currentWord || !currentWord.id) return;

  fetch(`/words/add-to-favorites/${currentWord.id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if(data.added) {
        showFavoriteMessage('–°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!');
      } else {
        showFavoriteMessage('–°–ª–æ–≤–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ!');
      }
    } else {
      showFavoriteMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.', true);
    }
  });
}

function showFavoriteMessage(text, isError = false) {
  const msg = document.getElementById('favorite-message');
  msg.textContent = text;
  msg.style.background = isError ? '#f44336' : '#4caf50';  // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–∫–∏, –∑–µ–ª–µ–Ω—ã–π ‚Äî –¥–ª—è —É—Å–ø–µ—Ö–∞
  msg.style.display = 'block';
  msg.style.opacity = '1';

  // —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º
  setTimeout(() => {
    msg.style.transition = 'opacity 0.5s ease';
    msg.style.opacity = '0';
    setTimeout(() => {
      msg.style.display = 'none';
      msg.style.transition = '';
    }, 500);
  }, 3000);
}

</script>

<style>
  #card-text {
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
  }

  .progress-bar {
    transition: width 0.5s ease;
  }

  .card {
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .btn-lg {
    padding: 0.7rem 1.5rem;
    font-weight: 500;
  }

  .alert-info {
    border-color: #d0ebff;
    color: #FFFFFF;
  }

  .alert-light {
    border-color: #e9ecef;
    color: #FFFFFF;
  }

  .my-btn-small-text {
    font-size: 0.75rem;
  }

  @media (max-width: 768px) {
    .btn-lg {
      width: 100%;
      margin-bottom: 0.5rem;
    }

    #action-buttons {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>
{% endblock %}